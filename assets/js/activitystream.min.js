function PsActivity(){this.current_post=null,this.page_loading=!1,this.is_ajax_loading=[]}var activity=new PsActivity;PsActivity.prototype.init=function(){var a=this;this.$post_container=jQuery("#ps-activitystream"),jQuery(".comment-container").each(function(a,b){0===jQuery("div",b).size()&&jQuery(this).hide()}),this.$post_container.size()>0&&jQuery(window).on("scroll",function(){jQuery(window).scrollTop()>=a.$post_container.offset().top+a.$post_container.outerHeight()-window.innerHeight&&!1===a.page_loading&&jQuery("#show-more-posts").trigger("click")}),jQuery(".ps-stream-content .cstream-respond").each(function(a,b){0===jQuery("div",b).not(".comment-container").size()&&jQuery(this).hide(),jQuery("textarea[name='comment']").autosize()});var b=window.location.hash;if(""!==b){var c=b.split("|");"#comment"===c[0]&&0===jQuery("#comment-item-"+c[1]).size()&&(jQuery(".comment-container[data-act-id="+c[2]+"]").one("comments.shown",function(){jQuery("html, body").delay(2e3).animate({scrollTop:jQuery("#comment-item-"+c[1]).offset().top},2e3)}),jQuery("a[href='#showallcomments']",".ps-js-activity--"+c[2]).trigger("click"))}jQuery(document).on("ps_activitystream_loaded peepso_repost_shown peepso_report_shown ps_activitystream_append",function(){a.toggle_anchor_target(),a.setup_comment_textarea()}),jQuery(document).trigger("ps_activitystream_loaded");var d="resize.activity-container";jQuery(window).off(d).on(d,_.debounce(function(){var a=($PeepSo.screenSize(),jQuery(".ps-stream-container")),b="ps-stream-container-narrow";a.width()<=480?a.addClass(b):a.removeClass(b)},500)).trigger(d)},PsActivity.prototype.setup_comment_textarea=function(){var a=this;jQuery("[data-type='stream-newcomment'] textarea").off("keydown.peepso"),jQuery("[data-type='stream-newcomment'] textarea").on("keydown.peepso",function(b){return a.on_comment_keydown(b)})},PsActivity.prototype.on_comment_keydown=function(a){if(a.shiftKey||a.ctrlKey)return!0;var b,c=a.keyCode?a.keyCode:a.which,d=jQuery(a.target);return 13===c&&""!==jQuery.trim(d.val())&&(b={el:d,can_submit:!0},b=ps_observer.apply_filters("comment_can_submit",b),b.can_submit)?(this.comment_save(d.data("act-id")),a.preventDefault(),!1):!0},PsActivity.prototype.toggle_anchor_target=function(){var a=new RegExp(location.host),b=jQuery(".ps-stream-content .cstream-attachment a, .ps-stream-content .content a, .ps-share-status-inner a").filter(function(){var b=jQuery(this).attr("href");return"http"===b.substring(0,4)?!a.test(b):!1});0==peepsodata.open_in_new_tab?b.removeAttr("target"):b.attr("target","_blank")},PsActivity.prototype.action_like=function(a,b){var c={act_id:b,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.like",c,function(c){var d;c.success?(d=jQuery(".ps-js-act-like--"+b),c.data.count>0?d.html(c.data.count_html).show():d.hide(),jQuery(a).replaceWith(c.data.like_html)):psmessage.show("",c.errors[0]).fade_out(psmessage.fade_time)}),!1},PsActivity.prototype.action_repost=function(a){var b={act_id:a,uid:peepsodata.currentuserid,user_id:peepsodata.user_id},c=jQuery("#repost-dialog .dialog-title").html();return content=jQuery("#ajax-loader-gif").html(),pswindow.show(c,content),$PeepSo.getJson("activity.ajax_show_post",b,function(b){if(0==b.success)return void pswindow.hide();var c=jQuery("#repost-dialog .dialog-content").html(),d=jQuery("#repost-dialog .dialog-action").html(),e=b.data.html.trim();e=e.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),c=c.replace("{post-content}",e),c=c.replace("{post-id}",a+""),pswindow.set_content(c).set_actions(d).refresh(),jQuery(document).trigger("peepso_repost_shown"),jQuery("#share-post-box","#ps-window").autosize(),jQuery("#cWindowContent .ps-dropdown-toggle").on("click",dropdown_toggle_click).on("mouseenter",dropdown_toggle_mouseenter),jQuery("#cWindowContent .dropdown-menu li a").click(function(a){var b=jQuery(a.target).closest("a"),c=jQuery("#cWindowContent .ps-dropdown-toggle"),d=jQuery("#cWindowContent input[name='repost_acc']"),e=c.find("a");b.closest(".ps-dropdown-toggle");c.find("i").attr("class",b.find("i").attr("class")),d.val(b.attr("data-option-value")),e.html(b.html())}),jQuery("#ps-window").on("pswindow.hidden",function(){jQuery("#cWindowContent .ps-dropdown-toggle").off("click").off("mouseenter")})}),!1},PsActivity.prototype.submit_repost=function(){var a=jQuery("#postbox-post-id","#ps-window").val(),b={content:jQuery("#share-post-box","#ps-window").val(),id:peepsodata.currentuserid,uid:peepsodata.currentuserid,repost:a,acc:jQuery("#cWindowContent input[name='repost_acc']").val(),type:"activity"};return b=ps_observer.apply_filters("postbox_req",b),$PeepSo.postJson("postbox.post",b,function(a){a.success&&(pswindow.set_content(a.notices[0]).refresh(),pswindow.fade_out(3e3,function(){("0"===peepsodata.userid||peepsodata.currentuserid===peepsodata.userid)&&(jQuery(a.data.html).hide().prependTo("#ps-activitystream").fadeIn("slow",function(){jQuery(document).trigger("peepso_repost_added");var b=a.data.post_id;jQuery("#peepso-wrap .ps-js-activity--"+b+" .ps-dropdown-toggle").click(dropdown_toggle_click).on("mouseenter",dropdown_toggle_mouseenter),jQuery("#peepso-wrap .ps-js-activity--"+b+" .dropdown-menu a").click(dropdown_toggle_a_click)}),jQuery("html, body").animate({scrollTop:jQuery("#ps-activitystream").offset().top},2e3))}))}),!1},PsActivity.prototype.action_report=function(a){var b={act_id:a,uid:peepsodata.currentuserid,user_id:peepsodata.user_id},c=jQuery("#activity-report-title").html();content=jQuery("#ajax-loader-gif").html(),pswindow.show(c,content),$PeepSo.getJson("activity.ajax_show_post",b,function(b){var c=jQuery("#activity-report-content").html(),d=b.data.html.trim();d=d.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),c=c.replace("{post-content}",d),c=c.replace("{post-id}",a+""),actions=jQuery("#activity-report-actions").html(),pswindow.set_content(c).set_actions(actions).refresh(),jQuery(document).trigger("peepso_report_shown")})},PsActivity.prototype.submit_report=function(){jQuery("#cWindowContent .report-error-div").hide();var a=jQuery("#postbox-report-popup #postbox-post-id","#ps-window").val(),b=jQuery("#rep_reason option:selected","#ps-window").val();if("0"===b){var c=jQuery("#report-error-select-reason").text();return jQuery("#cWindowContent .report-error-div").text(c).show(),!1}var d={act_id:a,uid:peepsodata.currentuserid,reason:b},e=ps_observer.apply_filters("activity_report_action","activity.report");return $PeepSo.getJson(e,d,function(a){a.success?(jQuery(window).trigger("report.submitted",a),pswindow.set_content(a.notices[0]).fade_out(pswindow.fade_time)):(pswindow.hide(),psmessage.show("",a.errors[0]).fade_out(psmessage.fade_time))}),!1},PsActivity.prototype.action_delete=function(a){var b=this;return pswindow.confirm_delete(function(){var c={postid:a,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.delete",c,function(c){b.toggle_comment_box(a,!1),c.success&&window.location.reload()}),pswindow.hide(),!1}),!1},PsActivity.prototype.on_commentbox_change=function(a){var b=jQuery(a);b.val().length>peepsodata.postsize&&b.val(b.val().substring(0,peepsodata.postsize)),""!==jQuery.trim(b.val())?(b.parents(".cstream-form-input").next(".cstream-form-submit").show(),b.parents(".cstream-form-input").next(".cstream-form-submit").find(".ps-comment-actions").show(),b.parents(".cstream-form-input").next(".cstream-form-submit").find(".ps-button-action").removeAttr("disabled")):(b.parents(".cstream-form-input").next(".cstream-form-submit").find(".ps-comment-actions").hide(),b.parents(".cstream-form-input").next(".cstream-form-submit").find(".ps-button-action").attr("disabled","disabled"))},PsActivity.prototype.comment_save=function(a,b){if(!this.is_ajax_loading["save-comment-"+a]){var c=this,d=jQuery("#act-new-comment-"+a+" .cstream-form-text");b&&b.tagName&&(d=jQuery(b).closest("#act-new-comment-"+a).find(".cstream-form-text")),jQuery("#act-new-comment-"+a+" .ps-comment-loading").show(),jQuery("#act-new-comment-"+a+" .ps-comment-actions").hide();var e=jQuery(d).val();return req=ps_observer.apply_filters("comment_req",{act_id:a,uid:peepsodata.currentuserid,content:e,last:jQuery(".comment-container[data-act-id="+a+"] .cstream-comment:last").data("comment-id")},d),this.is_ajax_loading["save-comment-"+a]=!0,$PeepSo.postJson("activity.makecomment",req,function(b){if(c.is_ajax_loading["save-comment-"+a]=!1,b.success){var e=jQuery(b.data.html);jQuery(".comment-container[data-act-id="+a+"]").show(),e.appendTo(".comment-container[data-act-id="+a+"]").hide().fadeIn(2e3),jQuery("#peepso-wrap").trigger("comment.saved",[a,d,req,e])}else psmessage.show("",b.errors[0]).fade_out(psmessage.fade_time);activity.comment_cancel(a),activity.current_post=null,jQuery("#act-new-comment-"+a+" .ps-comment-loading").hide(),jQuery("#act-new-comment-"+a+" .ps-comment-actions").hide(),jQuery("#act-new-comment-"+a+" .ps-button-action").attr("disabled","disabled"),"undefined"!=typeof b.data.has_max_comments&&c.toggle_comment_box(a,b.data.has_max_comments)}),!1}},PsActivity.prototype.comment_action_edit=function(a,b){if(!(jQuery("#comment-item-"+a+" .cstream-content .cstream-edit").size()>0)){var c=this,d=jQuery(b).closest("#comment-item-"+a);if(void 0===this.is_ajax_loading["comment-edit-"+a]||!1===this.is_ajax_loading["comment-edit-"+a]){this.is_ajax_loading["comment-edit-"+a]=!0;var e={postid:a,uid:peepsodata.currentuserid};$PeepSo.postJson("activity.editcomment",e,function(b){if(b.success){var e=jQuery(b.data.html);jQuery("[data-type='stream-comment-content']",d).first().hide().after(e),jQuery("#peepso-wrap").trigger("comment_edit.shown",[a,e]),jQuery(".cstream-edit textarea",d).on("input propertychange",function(){jQuery(this).val().length>peepsodata.postsize&&jQuery(this).val(jQuery(this).val().substring(0,peepsodata.postsize))}).autosize(),c.is_ajax_loading["comment-edit-"+a]=!1}})}return!1}},PsActivity.prototype.option_canceleditcomment=function(a,b){var c=jQuery(b).closest("#comment-item-"+a);return c.length>0&&(jQuery(".cstream-edit",c).remove(),jQuery("[data-type='stream-comment-content']",c).show()),!1},PsActivity.prototype.option_savecomment=function(a,b){var c=jQuery(b).closest("#comment-item-"+a);if(c.length>0){var d=jQuery(".cstream-edit textarea",c).val();jQuery(".cstream-edit textarea",c).attr("disabled","disabled"),jQuery(".ps-edit-loading",c).show(),jQuery(".cstream-edit button",c).hide();var e=ps_observer.apply_filters("comment_req",{postid:a,uid:peepsodata.currentuserid,post:d},jQuery(".cstream-edit textarea",c));$PeepSo.postJson("activity.savecomment",e,function(b){b.success?(jQuery(".cstream-edit",c).remove(),jQuery("[data-comment-id="+a+"] [data-type='stream-comment-content']").html(b.data.html),jQuery("[data-type='stream-comment-content']",c).show(),jQuery("[data-comment-id="+a+"] .cstream-content > .cstream-attachments").html(b.data.attachments),jQuery(".cstream-content > .cstream-attachments",c).show()):(psmessage.show("",b.notices[0]),jQuery(".cstream-edit button",c).show(),jQuery(".ps-edit-loading",c).hide(),jQuery(".cstream-edit textarea",c).removeAttr("disabled"))})}return!1},PsActivity.prototype.comment_action_delete=function(a){var b=this;pswindow.confirm_delete(function(){var c={postid:a,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.delete",c,function(c){b.toggle_comment_box(a,!1),c.success&&jQuery(".ps-comment-item[data-comment-id="+a+"]").remove(),pswindow.hide()}),!1})},PsActivity.prototype.comment_action_report=function(a){var b={act_id:a};return $PeepSo.getJson("activity.ajax_show_comment",b,function(b){var c=jQuery("#activity-report-title").html(),d=jQuery("#activity-report-content").html(),e=b.data.html.trim();e=e.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),d=d.replace("{post-content}",e),d=d.replace("{post-id}",a+""),ps_observer.add_filter("activitystream_notice_container",function(a,b){return"#comment-item-"+b+" .cstream-more"},10,2),actions=jQuery("#activity-report-actions").html(),pswindow.show(c,d).set_actions(actions).refresh(),jQuery("#ps-window").one("pswindow.hidden",function(){ps_observer.remove_filter("activitystream_notice_container",function(a,b){return"#comment-item-"+b+" .cstream-more"},10)})}),!1},PsActivity.prototype.comment_action_like=function(a,b){var c={act_id:b,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.like",c,function(c){var d;c.success?(d=jQuery(".ps-js-act-like--"+b),c.data.count>0?d.html(c.data.count_html).show():d.hide(),jQuery(a).replaceWith(c.data.like_html)):psmessage.show("",c.errors[0]).fade_out(psmessage.fade_time)}),!1},PsActivity.prototype.comment_cancel=function(a){var b=jQuery("#act-new-comment-"+a),c=b.find(".cstream-form-text");return b.find(".cstream-form-submit").hide(),c.val(""),ps_observer.apply_filters("comment_cancel",c),!1},PsActivity.prototype.show_likes=function(a){var b={act_id:a,uid:peepsodata.currentuserid},c=this;return(void 0===this.is_ajax_loading["likes-"+a]||!1===this.is_ajax_loading["likes-"+a])&&(this.is_ajax_loading["likes-"+a]=!0,$PeepSo.getJson("activity.get_like_names",b,function(b){jQuery("#act-like-"+a+" a").replaceWith(b.data.html),c.is_ajax_loading["likes-"+a]=!1})),!1},PsActivity.prototype.show_comments=function(a){var b={act_id:a,uid:peepsodata.currentuserid,first:jQuery(".comment-container[data-act-id="+a+"] .cstream-comment:first").data("comment-id")};return jQuery("#wall-cmt-"+a+" .comment-ajax-loader").toggleClass("hidden"),$PeepSo.getJson("activity.show_previous_comments",b,function(b){jQuery("#wall-cmt-"+a+" .ps-comment-more").fadeOut(),jQuery("#wall-cmt-"+a+" .comment-ajax-loader").toggleClass("hidden"),jQuery(".comment-container[data-act-id="+a+"]").prepend(b.data.html),setTimeout(function(){jQuery(".comment-container[data-act-id="+a+"]").trigger("comments.shown")},1)}),jQuery(this).hide(),!1},PsActivity.prototype.option_edit=function(a){var b={postid:a,uid:peepsodata.currentuserid},c=this;return(void 0===this.is_ajax_loading["edit-"+a]||!1===this.is_ajax_loading["edit-"+a])&&(this.is_ajax_loading["edit-"+a]=!0,$PeepSo.postJson("activity.editpost",b,function(b){if(b.success){var d=jQuery(b.data.html);jQuery(".ps-js-activity--"+b.data.act_id+" .cstream-attachment").first().hide().after(d),jQuery("#peepso-wrap").trigger("post_edit.shown",[b.data.act_id,d]);var e=jQuery(".ps-js-activity--"+b.data.act_id),f=e.find(".cstream-edit textarea"),g=e.find(".ps-postbox-charcount");f.on("input propertychange",function(){jQuery(this).val().length>peepsodata.postsize&&jQuery(this).val(jQuery(this).val().substring(0,peepsodata.postsize)),g.html(peepsodata.postsize-this.value.length)}).triggerHandler("input").autosize()}c.is_ajax_loading["edit-"+a]=!1})),!1},PsActivity.prototype.option_canceledit=function(a){var b=jQuery(".ps-js-activity--"+a);return b.length>0&&(jQuery(".cstream-edit",b).remove(),jQuery(".cstream-attachment",b).show()),!1},PsActivity.prototype.option_cancel_edit_description=function(a){var b=jQuery(".ps-js-modal-attachment--"+a);return b.length>0&&(jQuery(".cstream-edit",b).remove(),jQuery(".cstream-attachment",b).show()),!1},PsActivity.prototype.option_savepost=function(a){var b=jQuery(".ps-js-activity--"+a);if(b.length>0){var c=jQuery(".cstream-edit textarea",b).val();jQuery(".cstream-edit textarea",b).attr("disabled","disabled"),jQuery(".ps-edit-loading",b).show(),jQuery(".cstream-edit button",b).hide();var d=ps_observer.apply_filters("postbox_req_edit",{act_id:a,uid:peepsodata.currentuserid,post:c},jQuery(".cstream-edit textarea",b));$PeepSo.postJson("activity.savepost",d,function(a){jQuery(".cstream-edit",b).remove(),a.success?(jQuery(".cstream-attachment",b).html(a.data.html),jQuery(".cstream-attachments",b).html(a.data.attachments)):psmessage.show("",a.errors[0]),jQuery(".cstream-attachment, .cstream-attachments",b).show(),jQuery(document).trigger("peepso_post_edit_saved")})}return!1},PsActivity.prototype.option_save_description=function(a,b,c){var d=jQuery(".ps-js-modal-attachment--"+a);if(d.length>0){var e=jQuery(".cstream-edit textarea",d),f=e.val();jQuery(".cstream-edit textarea",d).attr("disabled","disabled"),jQuery(".ps-edit-loading",d).show(),jQuery(".cstream-edit button",d).hide();var g={act_id:a,type:b,object_id:c,uid:peepsodata.currentuserid,description:f};g=ps_observer.apply_filters("caption_req",g,e),$PeepSo.postJson("activity.save_description",g,function(a){jQuery(".cstream-edit",d).remove(),jQuery(".ps-stream-attachment",d).html(a.data.html).show()})}return!1},PsActivity.prototype.option_hide=function(a){var b={act_id:a,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.hidepost",b,function(b){b.success&&jQuery(".ps-js-activity--"+a).remove()}),!1},PsActivity.prototype.option_block=function(a,b){var c={uid:peepsodata.currentuserid,user_id:b};return $PeepSo.postJson("activity.blockuser",c,function(b){b.success&&jQuery(".ps-js-activity--"+a).remove()}),!1},PsActivity.prototype.load_page=function(a){if(+peepsodata.currentuserid>0){var b=this,c={uid:peepsodata.currentuserid,user_id:peepsodata.userid,page:a},d=this.$post_container;jQuery("#show-more-posts").hide(),jQuery(".post-ajax-loader").toggleClass("hidden"),this.page_loading=$PeepSo.getJson("activity.show_posts_per_page",c,function(a){var c;a.data.found_posts>0&&(c=jQuery(a.data.posts),c.appendTo(d).hide().fadeIn(1e3,function(){jQuery(document).trigger("ps_activitystream_loaded")}),jQuery("textarea[name='comment']",c).autosize(),jQuery("#div-show-more-posts").remove()),b.page_loading=!1,c||jQuery(document).trigger("ps_activitystream_loaded")}),jQuery(document).on("peepso_login_shown",function(){jQuery("#show-more-posts").show(),jQuery(".post-ajax-loader").toggleClass("hidden")})}},PsActivity.prototype.change_post_privacy=function(a,b){a=jQuery(a);var c=jQuery(".ps-js-privacy--"+b),d=jQuery(".ps-dropdown-toggle",c),e=(d.find("a"),d.find("i").attr("class"));d.find("i").attr("class",a.find("i").attr("class"));var f={uid:peepsodata.currentuserid,user_id:peepsodata.userid,acc:a.attr("data-option-value"),act_id:b,_wpnonce:peepsodata.peepso_nonce};return $PeepSo.postJson("activity.change_post_privacy",f,function(a){a.has_errors?(psmessage.show("",a.errors[0]).fade_out(psmessage.fade_time),d.find("i").attr("class",e)):a.success&&psmessage.show("",a.notices[0]).fade_out(psmessage.fade_time)}),!1},PsActivity.prototype.toggle_comment_box=function(a,b){var c=jQuery("#act-new-comment-"+a);if(c.length<=0){var d=jQuery("#comment-item-"+a);if(d.length<=0&&(d=jQuery(".ps-js-activity--"+a)),d.length>0){c=d.parent();var e=(d.parent().attr("id")+"").split("-").pop();c=jQuery("#act-new-comment-"+e)}}return c.length<=0?!1:(b?c.hide():c.show(),!1)},PsActivity.prototype.delete_activity=function(a){var b={act_id:a,uid:peepsodata.currentuserid,_wpnonce:jQuery("#_delete_nonce").val()},c=jQuery("[data-act-delete-id="+a+"]"),d="";return c.size()>0&&(d=c.text()),pswindow.confirm_delete(function(){$PeepSo.postJson("activity.ajax_delete_activity",b,function(a){a.success?window.location.reload():psmessage.show("",a.errors[0]).fade_out(psmessage.fade_time)})},d),!1},PsActivity.prototype.edit_activity_description=function(a,b,c){var d=jQuery(".ps-js-modal-attachment--"+a);if(!(d.find(".cstream-edit textarea").length>0)){var e={act_id:a,type:b,object_id:c,uid:peepsodata.currentuserid};return $PeepSo.postJson("activity.edit_description",e,function(a){if(a.success){var b=jQuery(a.data.html);d.find(".ps-stream-attachment").first().hide().after(b),jQuery("#peepso-wrap").trigger("post_edit.shown",[a.data.act_id,b]),d.find(".cstream-edit textarea").on("input propertychange",function(){jQuery(this).val().length>peepsodata.postsize&&jQuery(this).val(jQuery(this).val().substring(0,peepsodata.postsize))}).autosize().focus()}}),!1}},jQuery(document).ready(function(){activity.init()});