!function(a){function b(b,c){var d=this;return this.popover=null,this.popover_list=null,this.popover_footer=null,this.popover_header=null,this._notifications={},this.init=function(c){_opts={view_all_text:peepsodata.view_all_text,view_all_link:null,source:null,request:{per_page:10,page:1},header:null,paging:!1,fetch:null},this.opts=ps_observer.apply_filters("peepso_notification_plugin_options",_opts),this._content_is_fetched=!1,a.extend(!0,this.opts,c),a(b).addClass("psnotification-toggle"),this.popover=a("<div>"),this.popover_list=a("<ul>"),a(b).append(this.popover),!1===_.isNull(this.opts.header)&&(this.popover_header=a("<div/>"),this.popover_header.addClass("ps-popover-header app-box-header").append(this.opts.header).append("<div class='clearfix' />"),this.popover.append(this.popover_header)),this.popover.append(this.popover_list),this.popover_list.addClass("ps-popover-list empty"),this.popover.addClass("ps-popover app-box").hide(),this.opts.paging&&this.init_pagination(),!1===_.isNull(this.opts.view_all_link)&&(this.popover_footer=a("<div/>"),this.popover_footer.addClass("ps-popover-footer app-box-footer").append("<a href='"+this.opts.view_all_link+"'>"+this.opts.view_all_text+"</a>"),this.popover.append(this.popover_footer))},this.fetch=function(){var a=this.opts.request;_.isFunction(this.opts.fetch)&&(a=this.opts.fetch.call(this,a),!1===a)||(this._notifications={},$PeepSo.disableAsync().getJson(this.opts.source,a,function(a){a.success&&(d._content_is_fetched=!0,d._notifications=a.data.notifications,d._notifications.length>0&&d.opts.request.page++)}))},this.refresh=function(){this.popover_list.find("li").remove(),this._content_is_fetched=!1,this.load_page(function(){d.opts.paging&&d.popover_list.trigger("scroll")})},this.onClick=function(b){d.popover.has(a(b.target)).length>0||(b.preventDefault(),d.show(),d.load_page(function(){d.opts.paging&&d.popover_list.trigger("scroll")}))},this.render=function(){a.each(this._notifications,function(b,c){var e=a("<li></li>");e.html(c).hide(),e.appendTo(d.popover_list).fadeIn("slow")}),a(b).trigger("notifications.shown",[a.extend(b,this)]),this.popover_list.toggleClass("empty",0===this.popover_list.find("li").length)},this.show=function(){this.popover.slideToggle({duration:"fast",start:function(){d.popover.position({my:"right top",at:"bottom",of:a("i",b),within:"#peepso-wrap",using:function(b,c){"right"===c.horizontal?(a(this).removeClass("flipped"),b.left+=40):(a(this).addClass("flipped"),b.left-=40),b.top+=10,a(this).css(b)}})},done:function(){a(document).on("mouseup.notification_click",function(c){a(b).is(c.target)||0!==a(b).has(c.target).length||(d.popover.hide(),a(document).off("mouseup.notification_click"))})}})},this.init_pagination=function(){this.popover_list.scroll(function(){d._content_is_fetched&&a(this).scrollTop()+a(this).innerHeight()>=a(this)[0].scrollHeight&&(d._content_is_fetched=!1,d.load_page(function(){_.isEmpty(d._notifications)||d.popover_list.trigger("scroll")}))})},this.load_page=function(b){if(!1===this._content_is_fetched){var c=a("<div class='ps-popover-loading'><img src='"+peepsodata.loading_gif+"'/></div>");this.popover_list.after(c),setTimeout(function(){d.fetch(),c.remove(),d.render(),typeof b==typeof Function&&b()},500)}},this.init(c),a(b).on("click",this.onClick),this}function c(){peepsodata.currentuserid>0&&$PeepSo.disableError().getJson("notificationsajax.get_latest_count",null,function(b){var c,e,f;b.success&&!b.session_timeout&&(e=0,jQuery.each(b.data,function(b,d){c=Math.max(0,d.count),b.match(/ps-js-notifications|ps-js-friends-notification/)&&(e+=c),f=a("."+b),f.length&&f.find(".ps-js-counter")[c?"show":"hide"]().html(c)}),d(e))})}function d(a){var b=(document.title||"").replace(/^\(\d+\)\s*/,"");a>0&&(b="("+a+") "+b),document.title=b}a.fn.psnotification=function(c){return this.each(function(){if(a.data(this,"plugin_psnotification")){var d=a.data(this,"plugin_psnotification");if(_.isFunction(d[c]))return d[c].call(d)}else a.data(this,"plugin_psnotification",new b(this,c))})},c();var e=setInterval(c,3e4);a(window).on("peepso_auth_required",function(){clearInterval(e)})}(jQuery),jQuery(".dropdown-notification").psnotification({view_all_link:peepsodata.notifications_page,source:"notificationsajax.get_latest",request:{per_page:5},paging:!0});